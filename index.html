<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trung t√¢m H·ªçc t·∫≠p APSP ‚Ä¢ ·ª®ng d·ª•ng t√¨nh hu·ªëng: NƒÉng l·ª±c B·ªï tr·ª£ - Ra quy·∫øt ƒë·ªãnh</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0b1220; --muted:#5b6b7c; --line:#e6eef0;
      --g1:#22d3ee; --g2:#32bebb; --g3:#3bd2f0; --g4:#7dd3fc;
      --card:#ffffff; --glass:rgba(255,255,255,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
      background: radial-gradient(1200px 800px at -10% -10%, #f0fbff 0%, #ffffff 40%, #f7fbff 100%),
                  linear-gradient(160deg,#eefbff 0%, #ffffff 50%, #f4fffd 100%);
    }
    /* HEADER & NAV */
    .nav{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(120deg, rgba(34,211,238,.85), rgba(50,190,187,.85));
      backdrop-filter:saturate(140%) blur(8px);
      color:#05333a; border-bottom:1px solid rgba(255,255,255,.4);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:0 20px}
    .nav-row{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:12px 0}
    .brand{display:flex; align-items:center; gap:12px}
    .brand-logo{height:40px;width:auto;object-fit:contain;display:block;border-radius:10px;background:rgba(255,255,255,.85);padding:2px;box-shadow:0 8px 22px rgba(50,190,187,.35)}
    .brand-title{font-weight:800; letter-spacing:.2px; text-transform:uppercase; color:#fff}
    .nav-links{display:flex; gap:18px; align-items:center; flex-wrap:wrap}
    .nav-links a{color:#063a41; text-decoration:none; font-weight:700; opacity:.9}
    .btn-cta{appearance:none; border:0; border-radius:999px; padding:10px 16px; font-weight:800; cursor:pointer; color:#03343b;
      background:linear-gradient(90deg,var(--g2),var(--g3)); box-shadow:0 8px 18px rgba(50,190,187,.35)}

    /* CONFIG RIBBON */
    .config{display:none}
    .config.open{display:block}
    .config .panel{margin:10px auto 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:10px; border-radius:14px;
      background:var(--glass); border:1px solid rgba(255,255,255,.6); backdrop-filter: blur(8px)}
    .config input{flex:1; min-width:240px; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.08); outline:none}
    .config button{background:#eefbf9; border:1px solid #c6edea; color:#063a41; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer}

    /* HERO */
    .hero{padding:36px 0 18px}
    .hero-card{position:relative; overflow:hidden; border-radius:26px; background:linear-gradient(120deg, rgba(34,211,238,.15), rgba(50,190,187,.15));
      border:1px solid #e7f4f6; box-shadow:0 28px 60px rgba(13,110,139,.10)}
    .hero-inner{display:grid; grid-template-columns:1.1fr .9fr; gap:20px; padding:30px}
    @media (max-width: 980px){ .hero-inner{grid-template-columns:1fr; padding:22px} }
    .h1{font-size:38px; line-height:1.12; margin:6px 0 10px; font-weight:800; background:linear-gradient(90deg,var(--g1),var(--g2),var(--g3)); -webkit-background-clip:text; color:transparent}
    .lead{color:#3d5360; font-size:16px}
    .cta{display:flex; gap:10px; align-items:center; margin-top:12px}
    .btn-lg{appearance:none; border:0; border-radius:14px; padding:14px 18px; font-weight:800; cursor:pointer; color:#ffffff; text-decoration:none; display:inline-block; background:linear-gradient(90deg,var(--g2),var(--g3)); box-shadow:0 10px 24px rgba(50,190,187,.35)}
    .btn-ghost{appearance:none; border:1px solid rgba(3,52,59,.15); background:rgba(255,255,255,.75); backdrop-filter: blur(6px); color:#063a41; border-radius:14px; padding:12px 16px; font-weight:800; text-decoration:none; display:inline-block}

    /* SECTIONS */
    .section{padding:18px 0 34px}
    .section h2{font-size:24px; margin:0 0 12px; background:linear-gradient(90deg,var(--g2),var(--g1)); -webkit-background-clip:text; color:transparent}

    /* CARDS */
    .card{background:var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:0 16px 40px rgba(13,110,139,.08); overflow:hidden}
    .pad{padding:18px 20px}

    /* SCENARIO CHOICES */
    .choices{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px}
    @media (max-width:900px){ .choices{grid-template-columns:1fr} }
    .choice{display:flex; gap:12px; border:1px solid #e6eef0; padding:14px; border-radius:16px; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease}
    .choice:hover{transform:translateY(-2px); box-shadow:0 14px 28px rgba(50,190,187,.16)}
    .choice input{accent-color:#0ea5a4; transform:scale(1.2)}
    .procon{margin:.35rem 0 0 18px; color:#394b59; font-size:13px}
    .procon li{margin:.2rem 0}

    /* FORM */
    form{display:grid; gap:14px}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    .field{display:grid; gap:6px}
    .field label{font-weight:700; font-size:14px}
    input[type="text"], input[type="email"], select, textarea{width:100%; border:1px solid var(--line); border-radius:12px; padding:12px 14px; font:inherit; background:#fff; outline:none; transition:.2s border, .2s box-shadow}
    textarea{min-height:140px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:#8ee3df; box-shadow:0 0 0 4px rgba(50,190,187,.18)}
    .meter{display:flex; gap:8px; align-items:center}
    .meter .bar{flex:1; height:8px; background:#e9f7f6; border:1px solid #d7efed; border-radius:999px; overflow:hidden}
    .meter .bar>b{display:block; width:0%; height:100%; background:linear-gradient(90deg,var(--g2),var(--g3))}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tag{display:inline-block; background:rgba(2,60,91,.08); color:#063a41; padding:4px 8px; border-radius:999px; font-weight:800; font-size:12px}
    .muted{color:var(--muted); font-size:13px}

    .toast{position:fixed; bottom:16px; right:16px; background:linear-gradient(120deg,#03343b,#09515e); color:#e6fffb; padding:12px 14px; border-radius:12px; box-shadow:0 12px 22px rgba(2,60,91,.24); display:none; z-index:80}
    :focus-visible{outline:3px solid #7dd3fc; outline-offset:2px}
  .brand-fallback{height:40px;width:40px;border-radius:10px;background:conic-gradient(from 140deg,var(--g2),var(--g4),var(--g2));box-shadow:0 8px 22px rgba(50,190,187,.35);display:none}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <div class="wrap nav-row">
      <div class="brand">
        <img class="brand-logo" id="brandLogo" src="LogoSP-new2024-FINAL (1.1)_Bo2LogoAPSP-2024.png" alt="APSP & SP logo" />
        <div class="brand-fallback" id="brandFallback" aria-hidden="true"></div>
        <div class="brand-title">Trung t√¢m H·ªçc t·∫≠p APSP</div>
      </div>
      <div class="nav-links">
        <a href="#scenario">T√¨nh hu·ªëng</a>
        <a href="#answer">N·ªôp b√†i</a>
        <button class="btn-cta" id="toggleConfig">‚öôÔ∏é C·∫•u h√¨nh</button>
      </div>
    </div>
    <div class="wrap config" id="configPanel">
      <div class="panel">
        <input id="ep" placeholder="D√°n Web App URL (https://script.google.com/macros/s/‚Ä¶/exec)">
        <input id="tok" placeholder="appToken (tu·ª≥ ch·ªçn)">
        <button id="saveCfg">L∆∞u c·∫•u h√¨nh</button>
        <button id="openEP">M·ªü URL</button>
        <input id="logoFile" type="file" accept="image/*" style="display:none">
        <button id="pickLogo">Ch·ªçn logo</button>
      </div>
    </div>
  </nav>

  <!-- HERO CARD -->
  <header class="hero wrap">
    <div class="hero-card">
      <div class="hero-inner">
        <div>
          <div class="h1">·ª®ng d·ª•ng t√¨nh hu·ªëng: NƒÉng l·ª±c B·ªï tr·ª£ - Ra quy·∫øt ƒë·ªãnh</div>
          <p class="lead">ƒê·ªçc b·ªëi c·∫£nh th·ª±c t·∫ø, ch·ªçn ph∆∞∆°ng √°n ph√π h·ª£p, tr√¨nh b√†y l·∫≠p lu·∫≠n v√† g·ª≠i ngay ‚Äì d·ªØ li·ªáu ƒë·ªìng b·ªô v·ªÅ trung t√¢m ƒë√†o t·∫°o.</p>
          <div class="cta">
            <a class="btn-lg" href="#choices">B·∫Øt ƒë·∫ßu ngay</a>
            <a class="btn-ghost" href="#scenario">Xem b·ªëi c·∫£nh</a>
          </div>
        </div>
        <div class="card pad" id="scenario">
          <div class="badge">B·ªëi c·∫£nh</div>
          <ul class="list" style="margin-top:6px">
            <li>C√¥ng ty b·∫°n chuy√™n s·∫£n xu·∫•t v√† ph√¢n ph·ªëi d·∫ßu nh·ªùn cho c√°c ƒë·∫°i l√Ω v√† nh√† m√°y.</li>
            <li>M·ªôt kh√°ch h√†ng chi·∫øn l∆∞·ª£c v·ª´a <b>ƒë·∫∑t ƒë∆°n h√†ng g·∫•p 200.000 l√≠t</b> d·∫ßu nh·ªùn ƒë·ªông c∆° ƒë·ªÉ ph·ª•c v·ª• d√¢y chuy·ªÅn s·∫£n xu·∫•t.</li>
            <li>Kho v·∫≠n ƒë√£ s·ª≠ d·ª•ng l√¥ h√†ng <b>t·ªìn kho</b> m√† kh√¥ng ki·ªÉm tra h·∫°n s·ª≠ d·ª•ng. G·∫ßn h·∫°n giao h√†ng m·ªõi ph√°t hi·ªán to√†n b·ªô l√¥ ch·ªâ c√≤n <b>2 th√°ng</b>, trong khi h·ª£p ƒë·ªìng y√™u c·∫ßu t·ªëi thi·ªÉu <b>6 th√°ng</b>.</li>
            <li><b>Y√™u c·∫ßu quy·∫øt ƒë·ªãnh:</b> B·∫°n l√† Gi√°m ƒë·ªëc Nh√† m√°y ph·∫£i l·ª±a ch·ªçn ph∆∞∆°ng √°n x·ª≠ l√Ω ngay trong s√°ng h√¥m nay.</li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- SCENARIO CHOICES + FORM -->
  <main class="wrap section">
    <h2 id="choices">Ch·ªçn ph∆∞∆°ng √°n</h2>
    <div class="choices" aria-label="Ph∆∞∆°ng √°n">
      <label class="choice">
        <input type="radio" name="option" value="D·ª´ng ƒë∆°n & ho√†n ti·ªÅn">
        <div>
          <div class="name">1) D·ª´ng ƒë∆°n h√†ng & ho√†n ti·ªÅn cho kh√°ch</div>
          <ul class="procon">
            <li><b>L·ª£i:</b> Tr√°nh giao h√†ng kh√¥ng ƒë·∫°t y√™u c·∫ßu, b·∫£o v·ªá uy t√≠n.</li>
            <li><b>H·∫°i:</b> M·∫•t doanh thu ƒë∆°n h√†ng, nguy c∆° m·∫•t kh√°ch l√¢u d√†i.</li>
          </ul>
        </div>
      </label>
      <label class="choice">
        <input type="radio" name="option" value="Ch·∫ø l·∫°i l√¥ c·∫≠n date">
        <div>
          <div class="name">2) Ch·∫ø l·∫°i l√¥ s·∫£n ph·∫©m c·∫≠n date</div>
          <ul class="procon">
            <li><b>L·ª£i:</b> Gi·∫£m chi ph√≠/nguy√™n li·ªáu, r√∫t ng·∫Øn th·ªùi gian so v·ªõi s·∫£n xu·∫•t m·ªõi.</li>
            <li><b>H·∫°i:</b> Giao tr·ªÖ; r·ªßi ro v·ªÅ ch·∫•t l∆∞·ª£ng ho·∫∑c ph√°p l√Ω n·∫øu kh√°ch ki·ªÉm tra k·ªπ.</li>
          </ul>
        </div>
      </label>
      <label class="choice">
        <input type="radio" name="option" value="S·∫£n xu·∫•t l√¥ m·ªõi">
        <div>
          <div class="name">3) S·∫£n xu·∫•t l√¥ m·ªõi ƒë·∫°t y√™u c·∫ßu</div>
          <ul class="procon">
            <li><b>L·ª£i:</b> ƒê√°p ·ª©ng ƒë√∫ng y√™u c·∫ßu h·ª£p ƒë·ªìng v√† ti√™u chu·∫©n ch·∫•t l∆∞·ª£ng.</li>
            <li><b>H·∫°i:</b> Giao tr·ªÖ; ph√°t sinh chi ph√≠ s·∫£n xu·∫•t b·ªï sung.</li>
          </ul>
        </div>
      </label>
    </div>

    <section class="card pad" id="answer" style="margin-top:18px">
      <h2>N·ªôp c√¢u tr·∫£ l·ªùi</h2>
      <p class="sub">C√¢u tr·∫£ l·ªùi s·∫Ω ƒë∆∞·ª£c g·ª≠i v·ªÅ Google Sheets qua Apps Script.</p>
      <form id="f">
        <div class="row">
          <div class="field"><label for="fullName">H·ªç v√† t√™n <span style="color:#e11d48">*</span></label><input id="fullName" required placeholder="VD: Nguy·ªÖn VƒÉn A"></div>
          <div class="field"><label for="email">Email c√¥ng vi·ªác</label><input id="email" type="email" placeholder="ten@congty.com"></div>
        </div>
        <div class="row">
          <div class="field"><label for="dept">B·ªô ph·∫≠n</label>
            <select id="dept"><option value="">Ch·ªçn b·ªô ph·∫≠n</option>
              <option>B·ªò PH·∫¨N CUNG ·ª®NG</option>
              <option>PH√íNG K·∫æ TO√ÅN</option>
              <option>PH√íNG R &amp; D, QC</option>
              <option>PH√íNG NH√ÇN S·ª∞</option>
              <option>B·ªò PH·∫¨N K·ª∏ THU·∫¨T B·∫¢O TR√å</option>
              <option>B·ªò PH·∫¨N C√îNG NGH·ªÜ S·∫¢N XU·∫§T</option>
              <option>CHI NH√ÅNH MI·ªÄN B·∫ÆC</option>
              <option>B·ªò PH·∫¨N KHO V·∫¨N</option>
              <option>PH√íNG D·ªäCH V·ª§ CHƒÇM S√ìC KH√ÅCH H√ÄNG</option>
              <option>B·ªò PH·∫¨N PTTT</option>
              <option>PH√íNG XU·∫§T KH·∫®U</option>
              <option>PH√íNG QU·∫¢N L√ù K√äNH PH√ÇN PH·ªêI (GT)</option>
              <option>B·ªò PH·∫¨N AN TO√ÄN &amp; M√îI TR∆Ø·ªúNG</option>
              <option>PH√íNG MARKETING</option>
              <option>B·ªò PH·∫¨N H√ÄNG H·∫¢I</option>
              <option>T·ªîNG GI√ÅO ƒê·ªêC</option>
              <option>GI√ÅM ƒê·ªêC NH√Ä M√ÅY</option>
            </select>
          </div>
          <div class="field"><label for="scenarioId">M√£ t√¨nh hu·ªëng</label><input id="scenarioId" value="XL-GIAO-HANG-KHACH-LON-v1" readonly></div>
        </div>
        <div class="field">
          <label for="analysis">L√Ω do & c√°ch tri·ªÉn khai (100‚Äì250 t·ª´) <span style="color:#e11d48">*</span></label>
          <textarea id="analysis" required placeholder="Tr√¨nh b√†y l·∫≠p lu·∫≠n c·ªßa b·∫°n‚Ä¶"></textarea>
          <div class="meter"><small class="muted">M·ª•c ti√™u 100‚Äì250 t·ª´</small><div class="bar"><b id="pb"></b></div><small class="muted"><span id="wc">0</span> t·ª´</small></div>
        </div>
        <div class="actions">
          <button type="button" class="btn-ghost" id="save">L∆∞u nh√°p</button>
          <button class="btn-lg" id="submitBtn">G·ª≠i c√¢u tr·∫£ l·ªùi</button>
          <button type="button" class="btn-ghost" id="resetBtn">Xo√° bi·ªÉu m·∫´u</button>
          <span class="tag" id="st">Ch∆∞a g·ª≠i</span>
        </div>
</form>
    </section>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // üëâ B·ªçc to√†n b·ªô script trong IIFE ƒë·ªÉ **kh√¥ng t·∫°o bi·∫øn to√†n c·ª•c** (fix l·ªói tr√πng LS_TK, LS_EP khi ch·∫°y l·∫°i)
    (function(){
      'use strict';
      // Helpers (kh√¥ng ƒë·ªÉ global)
      const qs=(q,root=document)=>root.querySelector(q);
      const qsa=(q,root=document)=>Array.from(root.querySelectorAll(q));
      const toast=(m)=>{const t=qs('#toast'); if(!t) return; t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 3200)};

      // Toggle config ribbon (g·∫Øn 1 l·∫ßn duy nh·∫•t)
      const cfgBtn = qs('#toggleConfig');
      const cfgPanel = qs('#configPanel');
      if (cfgBtn && cfgPanel && !cfgBtn.dataset.bound) {
        cfgBtn.addEventListener('click', ()=> cfgPanel.classList.toggle('open'), { once:false });
        cfgBtn.dataset.bound = '1';
      }

      // LocalStorage keys (ƒë·∫∑t trong scope c·ª•c b·ªô ƒë·ªÉ kh√¥ng ƒë·ª•ng nhau gi·ªØa l·∫ßn ch·∫°y)
      const KEYS = { EP:'apsp-endpoint', TK:'apsp-token' };

      // Config bar bindings (ƒë·∫£m b·∫£o kh√¥ng bind l·∫∑p l·∫°i)
      const epInput = qs('#ep');
      const tkInput = qs('#tok');
      const saveBtn = qs('#saveCfg');
      const openBtn = qs('#openEP');
      const pickLogoBtn = qs('#pickLogo');
      const logoFile = qs('#logoFile');
      const logoImg = qs('#brandLogo');
      const logoFallback = qs('#brandFallback');

      if (epInput) epInput.value = localStorage.getItem(KEYS.EP) || '';
      if (tkInput) tkInput.value = localStorage.getItem(KEYS.TK) || '';
      // Load logo from localStorage if available
      const cachedLogo = localStorage.getItem('apsp-logo-datauri');
      if (cachedLogo && logoImg) logoImg.src = cachedLogo;

      if (saveBtn && !saveBtn.dataset.bound) {
        saveBtn.addEventListener('click', ()=>{
          localStorage.setItem(KEYS.EP, (epInput?.value||'').trim());
          localStorage.setItem(KEYS.TK, (tkInput?.value||'').trim());
          toast('ƒê√£ l∆∞u c·∫•u h√¨nh endpoint.');
        });
        saveBtn.dataset.bound='1';
      }
      if (openBtn && !openBtn.dataset.bound) {
        openBtn.addEventListener('click', ()=>{
          const u=(epInput?.value||'').trim(); if(u) window.open(u,'_blank'); else toast('Ch∆∞a c√≥ Web App URL.');
        });
        openBtn.dataset.bound='1';
      }
      // Pick logo (choose file -> save to localStorage -> apply)
      if (pickLogoBtn && !pickLogoBtn.dataset.bound) {
        pickLogoBtn.addEventListener('click', ()=> logoFile && logoFile.click());
        pickLogoBtn.dataset.bound='1';
      }
      if (logoFile && !logoFile.dataset.bound) {
        logoFile.addEventListener('change', async (e)=>{
          const f=e.target.files?.[0]; if(!f) return;
          const reader=new FileReader();
          reader.onload=()=>{ const uri=String(reader.result); localStorage.setItem('apsp-logo-datauri', uri); if(logoImg) logoImg.src = uri; toast('ƒê√£ c·∫≠p nh·∫≠t logo.'); };
          reader.readAsDataURL(f);
        });
        logoFile.dataset.bound='1';
      }
      // Logo show/hide fallback depending on load/error
      if (logoImg && !logoImg.dataset.bound) {
        logoImg.addEventListener('error', ()=>{ if(logoFallback) logoFallback.style.display='inline-block'; logoImg.style.display='none'; });
        logoImg.addEventListener('load', ()=>{ if(logoImg.naturalWidth>0){ logoImg.style.display='block'; if(logoFallback) logoFallback.style.display='none'; } });
        if(!logoImg.getAttribute('src')){ if(logoFallback) logoFallback.style.display='inline-block'; logoImg.style.display='none'; }
        logoImg.dataset.bound='1';
      }

      // Word counter
      const analysis=qs('#analysis'), wc=qs('#wc'), pb=qs('#pb');
      const upd=()=>{ const n=(analysis?.value.trim().match(/\b\w+\b/gu)||[]).length; if(wc) wc.textContent=n; if(pb) pb.style.width=Math.max(6,Math.min(100,Math.round((n/250)*100)))+'%'; };
      if (analysis && !analysis.dataset.bound) { analysis.addEventListener('input', upd); analysis.dataset.bound='1'; }
      upd();

      // Save/Load draft (guard ch·ªëng bind l·∫°i)
      const SK='apsp-scenario-XL-GIAO-HANG-v1';
      const saveDraftBtn = qs('#save');
      if (saveDraftBtn && !saveDraftBtn.dataset.bound){
        saveDraftBtn.addEventListener('click', ()=>{ const d=collect(); localStorage.setItem(SK, JSON.stringify(d)); toast('ƒê√£ l∆∞u nh√°p.'); });
        saveDraftBtn.dataset.bound='1';
      }
      (function load(){ try{ const s=localStorage.getItem(SK); if(!s) return; const d=JSON.parse(s); const fn=qs('#fullName'); if(fn) fn.value=d.fullName||''; const em=qs('#email'); if(em) em.value=d.email||''; const dp=qs('#dept'); if(dp) dp.value=d.dept||''; const r=qsa('input[name=option]').find(x=>x.value===d.option); if(r) r.checked=true; if(analysis){ analysis.value=d.analysis||''; upd(); } }catch(e){} })();

      const resetBtn = qs('#resetBtn');
      if (resetBtn && !resetBtn.dataset.bound){
        resetBtn.addEventListener('click', ()=>{ const form=qs('#f'); form?.reset(); upd(); const st=qs('#st'); if(st) st.textContent='Ch∆∞a g·ª≠i'; });
        resetBtn.dataset.bound='1';
      }

      function collect(){
        const opt=(qsa('input[name=option]').find(x=>x.checked)||{}).value||'';
        return {
          scenario_id: qs('#scenarioId')?.value,
          fullName: qs('#fullName')?.value.trim(),
          email: qs('#email')?.value.trim(),
          dept: qs('#dept')?.value,
          option: opt,
          analysis: analysis?.value.trim(),
          client_id: (localStorage.getItem('apsp-client-id')|| (window.crypto?.randomUUID?.()||String(Date.now()))),
          app_token: tkInput?.value||'',
          user_agent: navigator.userAgent,
          page: location.href
        };
      }

      const form = qs('#f');
      if (form && !form.dataset.bound){
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const endpoint=(localStorage.getItem(KEYS.EP) || epInput?.value || '').trim();
          if(!endpoint){ toast('Ch∆∞a c·∫•u h√¨nh Web App URL ·ªü n√∫t ‚öôÔ∏é C·∫•u h√¨nh.'); return; }
          const d=collect(); if(!d.fullName || !d.option || !d.analysis){ toast('Vui l√≤ng nh·∫≠p H·ªç & t√™n, ch·ªçn ph∆∞∆°ng √°n v√† vi·∫øt l√Ω do.'); return; }
          try{
            const body=new URLSearchParams(); Object.entries(d).forEach(([k,v])=> body.append(k, v ?? ''));
            await fetch(endpoint,{ method:'POST', mode:'no-cors', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
            toast('ƒê√£ g·ª≠i! (tr√¨nh duy·ªát c√≥ th·ªÉ kh√¥ng ƒë·ªçc ph·∫£n h·ªìi do CORS, nh∆∞ng d·ªØ li·ªáu ƒë√£ ƒëi)');
            const st=qs('#st'); if(st) st.textContent='ƒê√£ g·ª≠i';
            localStorage.removeItem(SK); form.reset(); upd();
          }catch(err){ console.error(err); toast('G·ª≠i l·ªói: '+err); const st=qs('#st'); if(st) st.textContent='L·ªói g·ª≠i'; }
        });
        form.dataset.bound='1';
      }

      // --- Mini tests (kh√¥ng thay ƒë·ªïi test c≈©, b·ªï sung test cho LS_* kh√¥ng global & bind 1 l·∫ßn) ---
      (function runTests(){
        const results=[];
        results.push(typeof window.$$==='undefined' ? 'PASS: $$ not defined' : 'FAIL: $$ exists');
        results.push(typeof window.LS_TK==='undefined' && typeof window.LS_EP==='undefined' ? 'PASS: no global LS_* vars' : 'FAIL: LS_* leaked to global');
        results.push(typeof qsa==='function' ? 'PASS: qsa exists' : 'FAIL: qsa missing');
        results.push(qsa('input[name=option]').length===3 ? 'PASS: 3 options' : 'WARN: options!=3');
        results.push(document.querySelector('#toggleConfig')?.dataset.bound==='1' ? 'PASS: toggle bound once' : 'WARN: toggle not bound');
        results.push(document.querySelector('#resetBtn')?.dataset.bound==='1' ? 'PASS: reset bound once' : 'WARN: reset not bound');
        results.push(document.querySelector('#save')?.dataset.bound==='1' ? 'PASS: save bound once' : 'WARN: save not bound');
        results.push(typeof (document.querySelector('#f')||{}).reset==='function' ? 'PASS: form.reset exists' : 'FAIL: form.reset missing');
        results.push(document.querySelector('#resetBtn') ? 'PASS: resetBtn exists' : 'FAIL: resetBtn missing');
        results.push(document.getElementById('choices') ? 'PASS: #choices anchor exists' : 'FAIL: #choices missing');
        results.push(document.querySelector('.btn-lg[href="#choices"]') ? 'PASS: CTA points to #choices' : 'FAIL: CTA href wrong');
        results.push(document.querySelector('.btn-ghost[href="#scenario"]') ? 'PASS: Ghost points to #scenario' : 'FAIL: Ghost href wrong');
        results.push(document.querySelector('#brandLogo') ? 'PASS: brandLogo node' : 'FAIL: brandLogo missing');
        results.push(document.querySelector('#brandFallback') ? 'PASS: brandFallback node' : 'FAIL: brandFallback missing');
        console.log('[APSP Neo‚ÄëGradient Tests]', results.join(' | '));
      })();
    })();
  </script>
</body>
</html>
